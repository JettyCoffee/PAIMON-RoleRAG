# PAIMON: RoleRAG

我们的项目希望构建一个角色扮演系统，研究跟角色自由对话的能力，可以跟角色聊生平，发生的事或者其他的，这个是游戏公司即使有这个原始的大纲图也还没做到的，提升角色的自我扮演能力！图的构建和查询是关键

项目需要拥有一个展示的前端，我们对于知识图谱的构建时提取的KG，需要展示出来，同时在问答的时候，我们需要做到既可以作为里面的一个角色与其他角色进行聊天，还可以跳脱出里面的角色，作为一个虚拟角色和他们聊天（这个需要在Agent检索部分做到检索的策略区分）

**数据源** datasets内的Harrypotter数据集（包含书本的所有故事文本）

## 1. 构建“双重信息”知识图谱

这是实现目标的第一步，即构建一个既包含“事实”又包含“风格”的图谱。

KG 构建方案如下：

- 将描述分割成块 `{𝒟1,𝒟2,…,𝒟n}` ，独立处理它们。对于每个块 𝒟i ，我们采用 LLMs 来细致地提取实体，遵循预定义的数据结构：`{name, type, persona, style_description, style_exemplars}`（type为character时）, `{name, type, description}`（type为non-character时），表示为 𝐧i 。其中 persona, style_description, style_exemplars 分别表示角色的基本简介、角色的说话性格、角色的口癖（风格的代表性文字）
- 此外，我们提示 LLMs 识别两个实体之间的结构关系，具体来说，`{source, target, description, attitude, strength}`，表示为 𝐫i ，其中 description 和 strength 和 attitude 分别表示源节点和目标节点之间的文本关系及其强度以及角色对相关的其他节点（角色或非角色）的态度和看法（这里和前文的两个实体间的关系不同的是，实体间关系是客观的事实，而此处的description是主观的想法）。
- 在处理完所有块之后，所有实体和关系都存储在全局数据库 𝒩 和 ℛ 中
- 在这之后还需要做一个语义歧义的检索，也就是需要分别识别角色节点间、非角色节点间是否是同一个object，参考RoleRAG的做法

## 2.  Agent 检索

采用华为 G2ConS 论文的思路，研究的核心是角色扮演，而文本直接提取的 KG 可能还会包含任务的概念。但是！角色和任务的概念都存在，是很方便后续的回答的检索的，我们只需要在检索的时候，强化“角色”这一概念的入点。（寻找与问题最相关的“非角色”概念的“该角色”作为检索的图的入点）

设计一个 Agent：

- **查询分解 (Decomposition)：**
  - 首先将问题拆解为多个可以对 KG 执行的具体子查询
  - 分为类型为角色和类型为事件的子查询（也就是对查询做分类）
  - 这个过程应参考 Youtu-GraphRAG，是“模式感知的”（Schema-Aware），即 Agent 知道图谱的结构。
- **迭代检索 (Retrieval & Reflection)：**
  - Agent 执行子查询，基于不同类型的查询在不同类型的社区摘要中查找，然后在社区内找到实体
  - Agent 会检查检索到的结果，如果信息不足，会“迭代反思”并生成新的子查询，直到收集到足够的信息。

## 3. LLM 生成回答

- **汇总信息：** 系统将所有检索到的信息片段（如图谱数据、社区摘要、原始文档片段）汇总起来。
- **构建上下文：** 这些零散信息被组合成一份完整的“上下文”材料。这份材料*必须*同时包含回答问题所需的“事实”和“风格”信息。
- **LLM 生成：** 最后，这份上下文被交给 LLM，LLM 依据这些信息，组织语言，生成一个既符合事实、又符合角色风格的最终答案。

## 4. 多轮记忆

1.保留最近 k 轮查询所得到的结果作为 Cache，Agent 检索前先判断 cache 能否满足生成的子查询，若信息够了就跳过检索 KG 阶段。

2.为每一轮对话的回答生成一份摘要，并和该轮问题一并保存，在 Agent 拆解问题前判断问题是否涉及需要 callback 前文的问题（比如，我们之前讨论的 xx 角色是什么样的？），如果有涉及到，就把该问题放在当前问题前，进行一次检索得到上下文，然后作为 cache，执行第一步。